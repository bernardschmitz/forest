<!DOCTYPE html>
<html>
	<body>

		<canvas id="myCanvas" width="400" height="300" style="border:1px solid #d3d3d3;">
		Your browser does not support the HTML5 canvas tag.</canvas>

		<script>

			var c = document.getElementById("myCanvas");
			var ctx = c.getContext("2d");


			function overlap(circle, circles) {

				for(var i=0; i<circles.length; i++) {
					var dx = circle[0] - circles[i][0];
					var dy = circle[1] - circles[i][1];
					var r  = circle[2] + circles[i][2];
					var d2 = dx*dx + dy*dy;

					if(d2 < r*r)
						return true;
				}

				return false;
			}

			function generateForest(woodDensity, radius, w, h) {

				var trees = [];

//				console.log(w*h*woodDensity);

				while(trees.length*Math.PI*radius*radius < w*h*woodDensity ) {

					do {
						var tree = [ Math.random()*w, Math.random()*h, radius ];
					}
					while(overlap(tree, trees));

					trees.push(tree);	

//					console.log(trees.length*Math.PI*radius*radius);
				}					

				return trees;
			}

			
			function generatePerson(trees, w, h) {

				do {
					var person = [ Math.random()*w, Math.random()*h, 2 ];
				}
				while(overlap(person, trees));

				return person;
			}

			function drawPerson(ctx, person, color) {

				ctx.beginPath();
				ctx.arc(person[0], person[1], person[2], 0, 2*Math.PI);
				ctx.fillStyle = color;
				ctx.fill();
			}

			function drawTrees(ctx, trees, color) {

				for(var i=0; i<trees.length; i++) {
					//ctx.moveTo(trees[i][0], trees[i][1]);
					ctx.beginPath();
					ctx.arc(trees[i][0], trees[i][1], trees[i][2], 0, 2*Math.PI);
					ctx.strokeStyle = color;
					ctx.stroke();
				}

			}

			function drawSightLine(ctx, from, to, color) {
				ctx.beginPath();
				ctx.strokeStyle = color;
				ctx.moveTo(from[0], from[1]);
				ctx.lineTo(to[0], to[1]);
				ctx.stroke();
			}

			function distance(from, to) {

				var dx = to[0] - from[0];
				var dy = to[1] - from[1];

				return Math.sqrt(dx*dx+dy*dy);
			}

			function distancePointLine(point, from, to) {

				var dx = to[0] - from[0];
				var dy = to[1] - from[1];

				var d = Math.sqrt(dx*dx+dy*dy);

				return Math.abs(dy*point[0] - dx*point[1] + to[0]*from[1] - to[1]*from[0]) / d;
				
			}


			function canSee(from, to, trees) {

				var left = Math.min(from[0], to[0]);
				var right = Math.max(from[0], to[0]);
				var top = Math.min(from[1], to[1]);
				var bottom = Math.max(from[1], to[1]);

				//console.log(from, to, left, right, top, bottom);

				for(var i=0; i<trees.length; i++) {

					var p = trees[i]
					var r = p[2];

					//console.log(p);

					if(p[0] >= left-r && p[0] <= right+r && p[1] >= top-r && p[1] <= bottom+r) {

						var d = distancePointLine(p, from, to); 
						//console.log(d);
						if(d < trees[i][2]) {
							return false;
						}
					}
				}

				return true;
			}


			function runOneTest(draw, density, radius, ctx, width, height) {

				var forest = generateForest(density, radius, width, height);
				var personA = generatePerson(forest, width, height);
				var personB = generatePerson(forest, width, height);
				var see = canSee(personA, personB, forest);

				if(draw) {
					ctx.fillStyle = 'white';
					ctx.fillRect(0,0,width,height);

					drawTrees(ctx, forest, 'black');	
					drawPerson(ctx, personA, 'blue');
					drawPerson(ctx, personB, 'green');

					if(see)
						drawSightLine(ctx, personA, personB, 'green');
					else
						drawSightLine(ctx, personA, personB, 'red');
				}



				return [see, distance(personA, personB)];
			}



			function runSightTests(draw, tests, density, radius, ctx, width, height, done) {

				var results = [];


				var runTests = function() {

					tests--;

					if(tests > 0) {
						results.push(runOneTest(draw, density, radius, ctx, width, height));
						setTimeout(runTests, 5);
					}
					else {
						done(results);
					}
				};


				if(draw)
					runTests();
				else {

					for(var i=0; i<tests; i++) {
						results.push(runOneTest(draw, density, radius, ctx, width, height));
					}

					done(results);
				}
			}



			var width = 400;
			var height = 300;

			var density = 0.1;
			var radius = 5;

			var N = 100;

			var tests = N;

			runSightTests(true, tests, density, radius, ctx, width, height, 
			
			function(results) {

				var seen = 0;
				for(var i=0; i<results.length; i++) {
					if(results[i][0]) {
						seen++;
					}
				}

				console.log(seen, N, seen*100/tests);	
			});

		</script> 

	</body>
</html>
